---

output:
  word_document:
    reference_docx: word_styles.docx
editor_options: 
  chunk_output_type: inline
  
---
```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

rm(list = ls())

```


```{r echo=FALSE, message=FALSE, warning=FALSE}
library("statnet")
library("dplyr")
library("knitr")
library("tidyr")
library("ggplot2")
library("readxl")
library("reshape2")
library("stringr")
library("RColorBrewer")
library("flextable")
library("tibble")
library("tidyverse")
library("network")
library("statnet")
library("UserNetR")
library("sna")
library("corrplot")
library("devtools")
library("data.table")
library("lemon")

```

## create network, nodes and edges

Creating a network for analysis actualizes connections between nodes and edges. These entities are used to create network objects that represent adjacency matrices, or sociomatricies, which are square matricies with nodes as the network's rows and columns and the binary connections (0, 1) as their edges. At its simplist connection, for example, a link between two nodes is represented by a 1, 0 otherwise. Sometimes networks can be directed where a node sends information to a recieving node, but the information is not reciprocated. In our case, our data is undirected and represents two groups, crimes and schools. ADD DESCRIPTION OF SOCIOMATRIX?? Density of the network = 0.03590093 

```{r echo=FALSE, message=FALSE, warning=FALSE}

crime150 <- read_xlsx("C:/Users/LW/Box/Mexico City Police 2020/data/buffer_150_crime3.xlsx")

#crime columns
delito_espesifico <- crime150$delito
delito_vec <- as.array(crime150$categoria_)
delito <- crime150$categoria_
crime_spot <- crime150$calle_hech
crime_neighbrhd <- crime150$colonia_he
crime_region <- crime150$alcaldia_h

# length(unique(delito_espesifico))

#school columns
escuela_todo <- crime150$escuela_nombre
nivel <- (crime150$escuela_nivel)
nombre <- crime150$escuela
school_address <- crime150$domicilio

# length(unique(nivel))
# table(delito_espesifico)
# length(unique(delito_espesifico))

# mtx1 <- matrix(crime150, nrow = length(unique(delito_espesifico)), ncol = length(unique(nivel)))

mtx_crime150 <- data.matrix(crime150)
# mtx_crime150
# glimpse(crime150)
# crime <- model.matrix(~ delito_espesifico + nivel -1)

new_crime <- crime150[, c("categoria_","delito", "escuela_nivel", "calle_hech", "colonia_he", "alcaldia_h", "escuela", "domicilio")]
crime_mtx <- data.matrix(new_crime)
# crime_mtx
# summary(crime_mtx, print.adj = FALSE)

mtx <- crime150[, c("delito", "escuela_nivel")]
# glimpse(mtx)
mtx_fin <- mtx %>% drop_na() #[complete.cases(mtx), ] #drop na's #na.omit(mtx) 
# glimpse(mtx_fin)



bin_crime <- as.data.frame.matrix(table(mtx_fin))
mtx_full <- as.matrix(bin_crime)
bin_crime <- as.matrix((bin_crime>0) +0)

crime_net <- network(bin_crime)
# dim(mtx_fin)

# summary(crime_net)

my.colors <- c(rep("red"), rep("blue"))
gplot(crime_net, gmode="twomode", 
      # label=c(rownames(delito_espesifico)[15:19], colnames(nivel)[15:19]),
      # label=c(rownames(bin_crime),colnames(bin_crime)),
      vertex.cex=2,
      vertex.col = my.colors,
      usearrows=TRUE,
      # label.col = my.colors,
      main = "Crime to School Network \n Blue = School, Red = Crime",
)
#       label=c(rownames(bin_crime)[15:19],colnames(bin_crime)[15:19]),

```


## Centrality Measures

Looking at the centrality measures of a network helps to identify various ways in which a node is connected to other nodes. There are 3 basic types of centrality measures including degree centrality, closeness centrality, and betweenness centrality. Degree centrality measures the number of connections a node is to other nodes within the network (Wasserman, Faust, 1994). Closeness centrality meausures how close a node is to all the other nodes in the network based on their distance apart, or how long it takes to get from one node to another. Betweenness centrality measures how many nodes a particular node sits between, for example, how central is this node for facilitating information flow within a network, are they an essential stop or can they be skipped?

The degree centrality for the top three school nodes is, PRIMARIA GENERAL (d = 198) translates to "public elementary school", PREESCOLAR GENERAL(d = 160) translantes to "public preschool", and SECUNDARIA GENERAL (d = 116) translates to "public middle school". The degree centrality for the top crime nodes is VIOLENCIA FAMILIAR (d = 30) translates to "domestic violence", ROBO A TRANSEUNTE EN VIA PUBLICA CON VIOLENCIA (d = 28) translates to "mugging", ROBO A NEGOCIO SIN VIOLENCIA (d = 24) translates to "non-violent business robbery", and AMENAZAS (d = 24) translates to "threats." With this information we can assume that public schools have a higher number of crimes in their neighborhood, and the top crimes in a school's a 150m radius are domestic "violence", "mugging", "non-violent business robbery", and "threats." Overall, the top ten nodes with the highest degree measures were schools, which is inline with the type of data we are using as schools in the center of their own 150m radius. 

The closeness centrality measures for the top three school nodes are "public elementary school", (c = 0.64), "public preschool" (c = 0.55), and "public middle school"(c = 0.47). The top crime centrality measure are "domestic violence" (c = 0.50), "mugging" (c = 0.49), "business robbery" (c = .048), and "threats" (c = 0.48). The top school and crime centralities are the same, but their order of greater closeness starts with "public elementary school", "public preschool", "domestic violence", and then "mugging". We can assume that these top nodes happen in close proximity to each other.

The top betweenness centrality measures for school nodes are also "public elementary school" (b = 11055.1143),"public preschool" (b = 6530.8892), and "public middle school" (b = 3473.3928). The top betweenness scores for crime slightly changed and their measures are, "domestic violence" (b = 1406.7534), "mugging" (b = 977.0407), and ROBO DE VEHICULO DE SERVICIO PARTICULAR SIN VIOLENCIA (b = 889.8290) translates to "non-violent theft of a private vehicle". The top 5 betweeness nodes overall are schools, meaning that schools are a central componenet for crimes in the neighborhood. This is expected because of the nature of the data and how the radius around the schools was set-up to collect the crime data.

```{r echo=FALSE, message=FALSE, warning=FALSE}

require(sna)

# summary(crime_net)
# crime_net$val

print("Degree Centrality: Crimes")
d.cent <- degree(crime_net) #[1:126, 1:126])
# d.cent
# table(d.cent)
names(d.cent) <- crime_net %v% "vertex.names"
sort.d <- sort(d.cent)
kable(sort.d[149:163])
# top.d <- names(sort(d.cent))[157:163]
# Draw the graph with node sizes proportional to betweenness centralitiy scores:
gplot(crime_net, vertex.col = my.colors, usearrows=TRUE, vertex.cex = .05 * d.cent) + #label=names(d.cent), #label=names(d.cent),
title(main = "Degree Centrality:Crime Network")



print("Closeness Centrality: Crimes")
c.cent <- closeness(crime_net, gmode = "digraph")
# c.cent
names(c.cent) <- crime_net %v% "vertex.names"
# sort(c.cent)
sort.c <- sort(c.cent)
kable(sort.c[153:163])
top.c <- names(sort(c.cent))#[155:163]
# note there are all 0s for closeness centrality
# Draw the graph with node sizes proportional to closeness centralitiy scores:
gplot(crime_net,  vertex.col = my.colors, usearrows=TRUE, vertex.cex = 5 * c.cent) + # label=names(c.cent),
title(main = "Closeness Centrality:Crime Network")

print("Betweeness Centrality: Crimes")
b.cent <- betweenness(crime_net, gmode = "digraph")
# table(b.cent)
names(b.cent) <- crime_net %v% "vertex.names"
sort.b <- sort(b.cent)
kable(sort.b[153:163])
# top.b <- names(sort(b.cent))[155:163]
# Draw the graph with node sizes proportional to closeness centralitiy scores:
gplot(crime_net, vertex.col = my.colors, usearrows=TRUE, vertex.cex = .05 * b.cent) + #  label=names(b.cent),
title(main = "Betweenness Centrality:crime Network")

```


## Duality and Bi-dynamic Line Graphs

The network is composed of two sets, crime and schools, where crime can belong to a group of crimes but also to the buffer raduis around a school, and visa vera. Understanding the value of connections within and between particular sets can help understand how a particular school might be connected to a particular crime. Breiger's duality measures consider the value of ties between a set of individuals and a set of groups (Breiger, 1974). In this case crime can be understood as individuals and schools as groups (side note, an interesting turn of events would be to look at overall crime categories to individual schools and see the difference between these networks). Similar to the set-up of the dataset, Breiger's axioms help describe the ties between crime and schools, specifically the second axiom of symmetry where two connecting nodes in a membership groups are both connected to each other, instead of one directed connection. Similarly, if two membership groups share a person they are mutually related (Breiger, 1974). In his first axiom Breiger also states, "an axiom that the intersection of any two sets belonging to either class [crime, schools] is contained in the power set of the other class" (Breiger, 1974). Essentially, these two statesments describe how crime nodes and school nodes can be related by similar connecting ties, and the destinction of reflexivity where belonging to a group is relatable and groups relate to their individual members. But what does this mean for crime and schools? 

As crimes connected within a school radius we can look further into the notion of duality by using a bipartite netowrk to consider the intersection of these two sets. In thier work on temporal dynamics of bipartite networks, Broccatelli et al use bipartite networks with a temporal aspect to modes covert networks to intersect actors and events across time (Broccatelli, et al., 2016). They implement three steps, an affiliation matrix of the two sets, they generate a line graph projection where edges between individuals are transformed to nodes while excluding redundant ties, and last they further reduce the ties to contain only the edges that connect the individual nodes to the group nodes (Broccatelli, et al., 2016). 

School to school ties within crime sets show how some schools are more prone to specific crimes. These are reciprocal ties that connect the two node types that interact with each other. In Figure# there are seven main school to school clusters with the crime set while eight other sets are connected outside of the typical crime space. In Figure# crime to crime ties within schools show a different behavior than their school-to-school counterpart where most crimes do not affiliate with each other showing distant parts, and little if any connections to other dissimilar crimes. This is an interesting outcome because it shows how crime around schools is somewhat independent of itself, instead of being connected to other crimes. The comparison of school to schools within crimes is also interesting because it shows how schools are connected based on the crimes being made within their radius. 

```{r echo=FALSE, message=FALSE, warning=FALSE}

# Broccatelli, Everett, Koskinen, "Temporal Dynamics in Covert Networks,"
#   Methodological Innovations 9 (2016). http://dx.doi.org/10.1177/2059799115622766


# Make program: findOnes:
findOnes<-function(M) {
  nR<-nrow(M)
  nC<-ncol(M)
  samerows<-matrix(rep((1:nC),nR),nrow=nR,byrow=T)
  samecols<-matrix(rep((1:nR),nC),nrow=nR)
  rows<-M*samecols
  rows<-as.vector(t(rows))
  rows<-rows[which(rows>0)]
  cols<-M*samerows
  cols<-as.vector(t(cols))
  cols<-cols[which(cols>0)]
  # out<-cbind(rows,cols)
  out<-cbind(rows,cols)
  return(out)
}

nTies <- sum(bin_crime>0)
# nTies
BD <- matrix(0, nTies, nTies)
nn <- rep("", nTies)
O <- findOnes(bin_crime)
for(k in 1:nTies){
    thisi <- O[k,1]; thisj <- O[k,2]
    nn[k] <- paste("S",thisi,"C",thisj, sep="")
  
}
rownames(BD) <- colnames(BD) <- nn

# Make a program that finds an index in BD:
findPE <-function(O,S,C) {
  # O is the output of findOnes(A)
  # P and E are index numbers of a person (P) and an event (E) in A;
  # S and C are index number of a school (S) and a crime (C) in the binary crime matrix;
  # output is the index number of that node SiCj in BD.
  out <- which((O[,1] == S) & (O[,2] == C))
  return(out)
}

# In BD, add all person-to-person ties WITHIN events
for (j in 1:ncol(bin_crime)) {
  if ((sum(bin_crime[,j])) > 0) {
    this <-outer(bin_crime[,j], bin_crime[,j])
    OJ <- findOnes(this)
    for (k in 1:nrow(OJ)) {
      ti <- findPE(O, OJ[k,1], j)
      tj <- findPE(O, OJ[k,2], j)
      BD[ti,tj] <- 1
    }}}
 
BDssc <- BD # These are the school-to-school ties WITHIN crimes.
ssc <- BDssc[1:100,1:100]
ssc3 <- BDssc[1:30,1:30]

gplot(ssc, gmode="twomode",
      usearrows=FALSE,
      main = "School to School ties WITHIN Crimes \n showing 100 examples")
gplot(ssc3, gmode="twomode",
            usearrows=FALSE,
      main = "School to School ties WITHIN Crimes \n showing 30 examples")


 # Now add all temporal crimes (connecting a crime to the next crime, whatever it is) WITHIN each school:
ncA <-ncol(bin_crime)


for (i in 1:nrow(bin_crime)) {
  for (j in 1:(ncA-1)) {
    if((bin_crime[i,j] ==1) & (sum(bin_crime[i,((j+1):ncA)]) > 0)) {
       this <-which(bin_crime[i,((j+1):ncA)] > 0)
       this <- ((j+1):ncA)[this]
       tj <- min(this)
      ti <- findPE(O, i, j)
      tj <- findPE(O, i, tj)
      # print(c(nn[ti], nn[tj]))
      BD[ti,tj] <- 1
    }
  }
}

BD <- BD * !(diag(nTies))

BDcct <- 0 + (BD & ! BDssc) # These are the time flow of crimes (connecting a crime to the next crime, whatever it is) WITHIN each school.
# The output, BD, is the union of BDssc and BDcct 
# Now, to see what we have done, we will plot affiliation matrix bin_crime, and then two different aspects of matrix BD
cct <- BDcct[1:100,1:100]
gplot(cct, gmode="twomode",
            usearrows=FALSE,
      main = "Crime to Crime within each School \n showing 100 examples")
gplot(cct[1:50,1:50], gmode="twomode",
            usearrows=FALSE,
      main = "Crime to Crime within each School \n showing 50 examples")

require(sna)
# # Plot matrix bin_crime:
my.colors <- c(rep("red",nrow(bin_crime)), rep("blue", ncol(bin_crime)))
gplot(bin_crime, gmode="twomode",
      label=c(rownames(bin_crime),colnames(bin_crime)),
      vertex.cex=1.5,
      usearrows=TRUE,
      # label.col = my.colors
      vertex.cols = my.colors,
      main = "School and Crime Network: \n Crime = red, School = blue"
)
# # print(bin_crime)

#create crime to school connections
c <- bin_crime %*% t(bin_crime)
gplot(c, edge.lwd = 4*c,
      label=rownames(c), #[15:25],
      usearrows=FALSE,
      main = "Crime to School Connections")

# plot school to crime connections
S <- t(bin_crime) %*% bin_crime
gplot(S, edge.lwd = 4*S,
      vertex.col="blue",
      label=rownames(S), #[15:25],
      usearrows=FALSE,
      main = "School to Crime Connections")


```

### Bi-dynamic line graph of school-to-school ties WITHIN crimes
```{r echo=FALSE, message=FALSE, warning=FALSE}
kable(ssc[1:10,1:10])

```

### Bi-dynamic line graph of time flow of crimes (connecting a crime to the next crime, whatever it is) WITHIN each school
```{r echo=FALSE, message=FALSE, warning=FALSE}

kable(cct[1:10,1:10])
```